<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SHADORON - Budget Discipline</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öîÔ∏è</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öîÔ∏è</text></svg>">
    <style>
        /* =========================================== CSS VARIABLES - THEMES =========================================== */
        :root {
            /* Stealth Dark Theme (Default) */
            --bg-primary: #0d0d14;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: #1a1a2e;
            --bg-card-hover: #252540;
            --text-primary: #eaeaea;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --positive: #10b981;
            --positive-bg: rgba(16, 185, 129, 0.1);
            --negative: #ef4444;
            --negative-bg: rgba(239, 68, 68, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --border: #2d2d44;
            --border-light: #3d3d5c;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.5);
            --gradient-accent: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-card: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-heading: 'Orbitron', sans-serif; /* Nouvelle typo pour chiffres */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s ease;
            --glass-bg: rgba(26, 26, 46, 0.6); /* Glassmorphism */
            --glass-border: rgba(99, 102, 241, 0.14);
        }

        /* Tactical Light Theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-card-hover: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --accent: #4f46e5;
            --accent-hover: #6366f1;
            --accent-glow: rgba(79, 70, 229, 0.2);
            --border: #e2e8f0;
            --border-light: #cbd5e1;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(79, 70, 229, 0.14);
        }

        /* Neon Warrior Theme */
        [data-theme="neon"] {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #12121a;
            --bg-card-hover: #1e1e2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0b0;
            --accent: #00f5d4;
            --accent-hover: #00e5c4;
            --accent-glow: rgba(0, 245, 212, 0.3);
            --positive: #00f5a0;
            --negative: #ff006e;
            --warning: #fee440;
            --border: #2a2a3a;
            --gradient-accent: linear-gradient(135deg, #00f5d4 0%, #00bbf9 100%);
            --glass-bg: rgba(10, 10, 15, 0.6);
            --glass-border: rgba(0, 245, 212, 0.14);
        }

        /* Minimal Zen Theme */
        [data-theme="zen"] {
            --bg-primary: #fafaf9;
            --bg-secondary: #f5f5f4;
            --bg-tertiary: #e7e5e4;
            --bg-card: #ffffff;
            --bg-card-hover: #fafaf9;
            --text-primary: #292524;
            --text-secondary: #78716c;
            --text-muted: #a8a29e;
            --accent: #78716c;
            --accent-hover: #57534e;
            --accent-glow: rgba(120, 113, 108, 0.2);
            --positive: #65a30d;
            --negative: #dc2626;
            --border: #d6d3d1;
            --gradient-accent: linear-gradient(135deg, #78716c 0%, #57534e 100%);
            --glass-bg: rgba(250, 250, 249, 0.6);
            --glass-border: rgba(120, 113, 108, 0.14);
        }

        /* =========================================== RESET & BASE =========================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Orbitron:wght@700&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html {
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
            scroll-behavior: smooth;
        }
        body {
            font-family: var(--font);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color var(--transition-slow), color var(--transition-slow);
        }

        /* =========================================== SCROLLBAR STYLING =========================================== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* =========================================== APP CONTAINER =========================================== */
        .app {
            max-width: 480px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: calc(80px + env(safe-area-inset-bottom));
            min-height: 100vh;
        }

        /* =========================================== HEADER =========================================== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            margin-bottom: 20px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 42px;
            height: 42px;
            background: var(--gradient-accent);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px var(--accent-glow);
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-actions {
            display: flex;
            gap: 8px;
        }
        .icon-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all var(--transition-fast);
            border: 1px solid var(--border);
        }
        .icon-btn:hover {
            background: var(--bg-card-hover);
            color: var(--accent);
            transform: translateY(-2px) scale(1.05); /* Micro-animation */
        }
        .icon-btn:active {
            transform: translateY(0) scale(1);
        }

        /* =========================================== LEVEL BADGE =========================================== */
        .level-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 6px 12px 6px 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .level-badge:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
            transform: scale(1.02); /* Micro-animation */
        }
        .level-icon {
            width: 28px;
            height: 28px;
            background: var(--gradient-accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .level-info {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        .level-rank {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .level-xp {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* =========================================== MORNING BRIEFING =========================================== */
        .morning-briefing {
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(160%);
            -webkit-backdrop-filter: blur(16px) saturate(160%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.38);
        }
        .morning-briefing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-accent);
        }
        .briefing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .briefing-greeting {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .briefing-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .briefing-mantra {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            border-left: 3px solid var(--accent);
        }
        .briefing-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .briefing-stat {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }
        .briefing-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
            font-family: var(--font-heading); /* Typo percutante */
        }
        .briefing-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Nouvelle section pour conseils financiers */
        .finance-tips {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
        }
        .tip-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent);
        }
        .tip-text {
            font-size: 0.875rem;
            margin-bottom: 12px;
        }

        /* =========================================== STREAK BANNER =========================================== */
        .streak-banner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gradient-success);
            border-radius: var(--radius-lg);
            padding: 14px 16px;
            margin-bottom: 20px;
            color: white;
            animation: pulse-streak 2s infinite; /* Pulse doux si >3 */
        }
        @keyframes pulse-streak {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .streak-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .streak-icon {
            font-size: 24px;
            animation: flame 1s ease-in-out infinite;
        }
        @keyframes flame {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .streak-text {
            line-height: 1.3;
        }
        .streak-count {
            font-size: 1.1rem;
            font-weight: 700;
        }
        .streak-label {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        .streak-best {
            text-align: right;
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* =========================================== CARDS =========================================== */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(160%);
            -webkit-backdrop-filter: blur(16px) saturate(160%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            transition: all var(--transition-normal);
            animation: cardAppear 0.4s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.38);
        }
        @keyframes cardAppear {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card:hover {
            border-color: var(--border-light);
            transform: translateY(-2px); /* Micro-animation */
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .card-action {
            font-size: 0.75rem;
            color: var(--accent);
            cursor: pointer;
            transition: color var(--transition-fast);
        }
        .card-action:hover {
            color: var(--accent-hover);
        }

        /* =========================================== BALANCE CARDS =========================================== */
        .total-balance-card {
            background: var(--gradient-accent);
            border: none;
            padding: 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.38);
        }
        .total-balance-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }
        .total-balance-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .total-balance-value {
            font-size: 2rem;
            font-weight: 800;
            color: white;
            position: relative;
            z-index: 1;
            font-family: var(--font-heading); /* Typo percutante */
            animation: count-up 1s ease; /* Counter animation */
        }
        @keyframes count-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .balances-grid {
            display: grid;
            gap: 10px;
        }
        .balance-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            transition: all var(--transition-fast);
        }
        .balance-item:hover {
            border-color: var(--border-light);
            transform: translateX(4px) scale(1.01); /* Micro-animation */
        }
        .balance-item.negative {
            background: var(--negative-bg);
            border-color: var(--negative);
            animation: shake 0.5s; /* Confirmation n√©gatif */
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        .balance-item.locked {
            background: var(--positive-bg);
            border-color: var(--positive);
        }
        .balance-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .balance-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: var(--bg-card);
        }
        .balance-name {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .balance-percent {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .balance-value {
            font-size: 1rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            font-family: var(--font-heading);
        }
        .balance-value.positive {
            color: var(--positive);
        }
        .balance-value.negative {
            color: var(--negative);
        }

        /* =========================================== BOTTOM NAVIGATION =========================================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid var(--glass-border);
            padding: 8px 16px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            z-index: 100;
            box-shadow: 0 -4px 30px rgba(0,0,0,0.4);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border: none;
            background: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: var(--radius-md);
            position: relative;
        }
        .nav-item:hover {
            color: var(--text-secondary);
            transform: scale(1.1); /* Scale + bounce nav */
        }
        .nav-item.active {
            color: var(--accent);
        }
        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
        }
        .nav-icon {
            font-size: 20px;
        }
        .nav-label {
            font-size: 0.65rem;
            font-weight: 500;
        }

        /* =========================================== TAB CONTENT =========================================== */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================== FORMS =========================================== */
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            font-size: 1rem;
            font-family: var(--font);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            transition: all var(--transition-fast);
            -webkit-appearance: none;
            appearance: none;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        .form-input::placeholder {
            color: var(--text-muted);
        }
        .form-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239ca3af' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        /* =========================================== BUTTONS =========================================== */
        .btn {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            font-family: var(--font);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #a78bfa 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5);
        }
        .btn-primary:active {
            transform: translateY(0) scale(1);
        }
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            border-color: var(--accent);
        }
        .btn-danger {
            background: var(--negative);
            color: white;
        }
        .btn-sm {
            padding: 10px 16px;
            font-size: 0.875rem;
            width: auto;
        }

        /* =========================================== PREVIEW DISTRIBUTION =========================================== */
        .preview-card {
            background: var(--accent-glow);
            border: 1px solid var(--accent);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 16px;
        }
        .preview-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .preview-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.875rem;
        }
        .preview-row .label {
            color: var(--text-secondary);
        }
        .preview-row .value {
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        /* =========================================== ALLOCATION CONFIG =========================================== */
        .allocation-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .allocation-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }
        .allocation-row label {
            flex: 1;
            font-size: 0.875rem;
            margin: 0;
        }
        .allocation-row input {
            width: 70px;
            padding: 8px 10px;
            text-align: right;
            font-size: 0.875rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
        }
        .allocation-row input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .allocation-total {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin-top: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-weight: 600;
        }
        .allocation-total.error {
            color: var(--negative);
        }
        .allocation-total.success {
            color: var(--positive);
        }

        /* =========================================== HISTORY LIST =========================================== */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }
        .history-item:hover {
            transform: translateX(4px);
        }
        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .history-icon.income {
            background: var(--positive-bg);
            color: var(--positive);
        }
        .history-icon.expense {
            background: var(--negative-bg);
            color: var(--negative);
        }
        .history-details {
            flex: 1;
            min-width: 0;
        }
        .history-category {
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-date {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .history-amount {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        .history-amount.positive {
            color: var(--positive);
        }
        .history-amount.negative {
            color: var(--negative);
        }
        .history-delete {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            opacity: 0.5;
        }
        .history-delete:hover {
            opacity: 1;
            background: var(--negative-bg);
            color: var(--negative);
        }
        .no-history {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        .no-history-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* =========================================== XP & LEVEL PROGRESS =========================================== */
        .xp-progress {
            margin-bottom: 16px;
        }
        .xp-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .xp-level {
            font-size: 0.875rem;
            font-weight: 600;
        }
        .xp-amount {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .xp-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }
        .xp-fill {
            height: 100%;
            background: var(--gradient-accent);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* =========================================== BADGES GRID =========================================== */
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }
        .badge-item.unlocked {
            background: var(--accent-glow);
            border: 1px solid var(--accent);
        }
        .badge-item.locked {
            opacity: 0.4;
            filter: grayscale(1);
        }
        .badge-icon {
            font-size: 24px;
        }
        .badge-name {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* =========================================== HABITS / STREAK CALENDAR =========================================== */
        .habit-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 12px;
        }
        .calendar-day {
            aspect-ratio: 1;
            border-radius: 4px;
            background: var(--bg-tertiary);
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
        .calendar-day.active {
            background: var(--positive);
            color: white;
        }
        .calendar-day.today {
            border: 2px solid var(--accent);
        }

        /* =========================================== SETTINGS =========================================== */
        .settings-group {
            margin-bottom: 24px;
        }
        .settings-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .settings-item:hover {
            background: var(--bg-card-hover);
        }
        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .settings-item-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-item-text {
            line-height: 1.3;
        }
        .settings-item-label {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .settings-item-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        /* Theme Selector */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .theme-option {
            padding: 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-align: center;
        }
        .theme-option:hover {
            border-color: var(--border-light);
        }
        .theme-option.active {
            border-color: var(--accent);
            background: var(--accent-glow);
        }
        .theme-preview {
            width: 100%;
            height: 40px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }
        .theme-name {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* =========================================== SEARCH MODAL =========================================== */
        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 60px 16px 16px;
            animation: fadeIn 0.2s ease;
        }
        .search-modal.active {
            display: block;
        }
        .search-container {
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .search-input-wrapper .search-icon {
            color: var(--text-muted);
        }
        .search-input {
            flex: 1;
            background: none;
            border: none;
            font-size: 1rem;
            color: var(--text-primary);
            outline: none;
        }
        .search-input::placeholder {
            color: var(--text-muted);
        }
        .search-shortcut {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        .search-result-item:hover {
            background: var(--bg-tertiary);
        }
        .search-result-icon {
            font-size: 1.25rem;
        }
        .search-result-text {
            flex: 1;
        }
        .search-result-title {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .search-result-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* =========================================== MODALS =========================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 16px;
            align-items: center;
            justify-content: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 24px;
            animation: modalAppear 0.3s ease;
        }
        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 50%;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        .modal-close:hover {
            background: var(--negative-bg);
            color: var(--negative);
        }

        /* =========================================== ALERTS & TOASTS =========================================== */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: calc(100% - 32px);
            max-width: 400px;
        }
        .toast {
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastSlide 0.3s ease;
        }
        @keyframes toastSlide {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast.success {
            border-color: var(--positive);
            background: var(--positive-bg);
        }
        .toast.error {
            border-color: var(--negative);
            background: var(--negative-bg);
        }
        .toast.warning {
            border-color: var(--warning);
            background: var(--warning-bg);
        }
        .toast-icon {
            font-size: 1.25rem;
        }
        .toast-message {
            flex: 1;
            font-size: 0.875rem;
        }

        /* =========================================== XP POPUP =========================================== */
        .xp-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--gradient-accent);
            color: white;
            padding: 20px 40px;
            border-radius: var(--radius-xl);
            font-size: 1.5rem;
            font-weight: 700;
            z-index: 3000;
            animation: xpPop 0.6s ease forwards;
            pointer-events: none;
        }
        @keyframes xpPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -100%) scale(1); }
        }

        /* =========================================== CONFETTI =========================================== */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2500;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(-100vh) rotate(0deg); }
            100% { opacity: 0; transform: translateY(100vh) rotate(720deg); }
        }
        .confetti-star {
            font-size: 12px;
            content: '‚≠ê'; /* Confetti plus styl√© avec formes */
        }

        /* =========================================== OFFLINE BADGE =========================================== */
        .offline-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--warning);
            color: black;
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 100;
            display: none;
            animation: pulse 2s infinite;
        }
        .offline-badge.show {
            display: block;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* =========================================== RESPONSIVE =========================================== */
        @media (max-width: 380px) {
            html { font-size: 14px; }
            .app { padding: 12px; }
            .briefing-stats { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .badges-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* =========================================== LOADING SPINNER =========================================== */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* =========================================== EMPTY STATE =========================================== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        .empty-state-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .empty-state-desc {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Nouvelle section pour graphique */
        .chart-card {
            height: 250px;
        }

        /* Quick actions */
        .quick-actions {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .quick-btn {
            padding: 12px;
            background: var(--gradient-accent);
            color: white;
            border-radius: var(--radius-lg);
            text-align: center;
            width: 30%;
            font-weight: 600;
            cursor: pointer;
            transition: transform var(--transition-fast);
        }
        .quick-btn:hover {
            transform: scale(1.05);
        }

        /* Objectif √©pargne */
        .savings-goal {
            margin-top: 16px;
        }
        .goal-jauge {
            height: 10px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            overflow: hidden;
        }
        .goal-fill {
            height: 100%;
            background: var(--positive);
            transition: width 0.5s ease;
        }

        /* Toggle vue mensuelle */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .toggle-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
        }
        .toggle-btn.active {
            background: var(--accent);
            color: white;
        }
    </style>
    <!-- Ajout de Chart.js pour graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app">
        <!-- HEADER -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">‚öîÔ∏è</div>
                <span class="logo-text">SHADORON</span>
            </div>
            <div class="header-actions">
                <div class="level-badge" id="level-badge" onclick="showLevelModal()">
                    <div class="level-icon">üéñÔ∏è</div>
                    <div class="level-info">
                        <span class="level-rank" id="current-rank">Recrue</span>
                        <span class="level-xp" id="current-xp">0 XP</span>
                    </div>
                </div>
                <button class="icon-btn" onclick="openSearch()" title="Recherche (Ctrl+K)">üîç</button>
                <button class="icon-btn" onclick="switchTab('settings')" title="Parametres">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- TOAST CONTAINER -->
        <div class="toast-container" id="toast-container"></div>

        <!-- ============ TAB: DASHBOARD ============ -->
        <div id="tab-dashboard" class="tab-content active">
            <!-- Morning Briefing -->
            <div class="morning-briefing" id="morning-briefing">
                <div class="briefing-header">
                    <div>
                        <div class="briefing-greeting" id="greeting">Bonjour, Guerrier</div>
                        <div class="briefing-date" id="current-date"></div>
                    </div>
                </div>
                <div class="briefing-mantra" id="daily-mantra">
                    "La discipline est le pont entre les objectifs et les accomplissements."
                </div>
                <div class="briefing-stats">
                    <div class="briefing-stat">
                        <div class="briefing-stat-value" id="stat-streak">0</div>
                        <div class="briefing-stat-label">Jours</div>
                    </div>
                    <div class="briefing-stat">
                        <div class="briefing-stat-value" id="stat-transactions">0</div>
                        <div class="briefing-stat-label">Operations</div>
                    </div>
                    <div class="briefing-stat">
                        <div class="briefing-stat-value" id="stat-savings">0</div>
                        <div class="briefing-stat-label">Epargne %</div>
                    </div>
                </div>
            </div>

            <!-- Conseils Financiers Modernes (plus de citations et intelligence) -->
            <div class="finance-tips">
                <div class="tip-title">Conseil du Jour: √âviter le Biais d'Ancrage</div>
                <div class="tip-text">Le biais d'ancrage en finance est la tendance √† s'appuyer trop sur la premi√®re information re√ßue (comme un prix initial) lors de d√©cisions. Pour l'√©viter, comparez toujours plusieurs options et r√©√©valuez vos budgets mensuellement.</div>
                <div class="tip-text">"L'argent est un outil. Utilisez-le avec sagesse pour b√¢tir votre avenir." - Citation financi√®re moderne.</div>
                <div class="tip-text">"Investissez dans ce qui vous rend libre, pas dans ce qui vous encha√Æne." - Principe de finance personnelle.</div>
            </div>

            <!-- Streak Banner -->
            <div class="streak-banner" id="streak-banner" style="display: none;">
                <div class="streak-info">
                    <span class="streak-icon">üî•</span>
                    <div class="streak-text">
                        <div class="streak-count" id="streak-count">0 jours</div>
                        <div class="streak-label">de discipline consecutive</div>
                    </div>
                </div>
                <div class="streak-best"> Record: <span id="best-streak">0</span> jours </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-btn" onclick="switchTab('income')">+ Revenu</div>
                <div class="quick-btn" onclick="quickExpense('nourriture')">- Nourriture</div>
                <div class="quick-btn" onclick="quickExpense('transport')">- Transport</div>
            </div>

            <!-- Total Balance Card -->
            <div class="card total-balance-card">
                <div class="total-balance-label">Total Disponible</div>
                <div class="total-balance-value" id="total-balance">0 FCFA</div>
            </div>

            <!-- Balances Grid -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Soldes par Categorie</span>
                </div>
                <div class="view-toggle">
                    <div class="toggle-btn active" onclick="toggleView('all')">Tout</div>
                    <div class="toggle-btn" onclick="toggleView('month')">Ce mois</div>
                </div>
                <div class="balances-grid" id="balances-grid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Graphique D√©penses -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">R√©partition D√©penses</span>
                </div>
                <canvas id="expense-chart" class="chart-card"></canvas>
            </div>

            <!-- Objectif Epargne -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Objectif Epargne</span>
                </div>
                <div class="savings-goal">
                    <div id="goal-progress">0 / 0 FCFA</div>
                    <div class="goal-jauge">
                        <div class="goal-fill" id="goal-fill" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- Habit Calendar -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Activite des 30 derniers jours</span>
                </div>
                <div class="habit-calendar" id="habit-calendar">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- ============ TAB: INCOME ============ -->
        <div id="tab-income" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Ajouter un Revenu</span>
                </div>
                <form id="income-form">
                    <div class="form-group">
                        <label class="form-label">Montant recu (FCFA)</label>
                        <input type="number" id="income-amount" class="form-input" min="0" step="1" placeholder="0" required>
                    </div>
                    <div id="income-preview" class="preview-card" style="display: none;">
                        <div class="preview-title">Repartition automatique</div>
                        <div id="preview-rows"></div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <button type="submit" class="btn btn-primary">
                            <span>Enregistrer</span>
                            <span>+10 XP</span>
                        </button>
                    </div>
                </form>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Pourcentages de Repartition</span>
                </div>
                <div class="allocation-grid" id="allocation-config"></div>
                <div class="allocation-total" id="allocation-total">
                    <span>Total</span>
                    <span id="total-percent">100%</span>
                </div>
            </div>
        </div>

        <!-- ============ TAB: EXPENSE ============ -->
        <div id="tab-expense" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Enregistrer une Depense</span>
                </div>
                <form id="expense-form">
                    <div class="form-group">
                        <label class="form-label">Categorie</label>
                        <select id="expense-category" class="form-select" required>
                            <option value="">Choisir une categorie</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Montant (FCFA)</label>
                        <input type="number" id="expense-amount" class="form-input" min="0" step="1" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note (optionnel)</label>
                        <input type="text" id="expense-note" class="form-input" placeholder="Description">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <span>Enregistrer</span>
                            <span>+5 XP</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ============ TAB: HISTORY ============ -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Historique des Operations</span>
                    <span class="card-action" onclick="exportData()">Exporter</span>
                </div>
                <div class="history-list" id="history-list">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- ============ TAB: PROGRESS ============ -->
        <div id="tab-progress" class="tab-content">
            <!-- XP Progress -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Progression</span>
                </div>
                <div class="xp-progress">
                    <div class="xp-header">
                        <span class="xp-level" id="progress-level">Niveau 1 - Recrue</span>
                        <span class="xp-amount" id="progress-xp">0 / 100 XP</span>
                    </div>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xp-fill" style="width: 0%;"></div>
                    </div>
                </div>
                <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem;">
                    Prochain niveau: <span id="next-rank">Soldat</span>
                </div>
            </div>

            <!-- Badges -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Badges Debloques</span>
                    <span class="card-action" id="badges-count">0/12</span>
                </div>
                <div class="badges-grid" id="badges-grid">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Stats -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Statistiques</span>
                </div>
                <div class="balances-grid">
                    <div class="balance-item">
                        <div class="balance-left">
                            <div class="balance-icon">üìä</div>
                            <div>
                                <div class="balance-name">Total Operations</div>
                            </div>
                        </div>
                        <div class="balance-value" id="stats-total-ops">0</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-left">
                            <div class="balance-icon">üí∞</div>
                            <div>
                                <div class="balance-name">Total Revenus</div>
                            </div>
                        </div>
                        <div class="balance-value positive" id="stats-total-income">0</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-left">
                            <div class="balance-icon">üí∏</div>
                            <div>
                                <div class="balance-name">Total Depenses</div>
                            </div>
                        </div>
                        <div class="balance-value negative" id="stats-total-expense">0</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-left">
                            <div class="balance-icon">üîí</div>
                            <div>
                                <div class="balance-name">Epargne Accumulee</div>
                            </div>
                        </div>
                        <div class="balance-value positive" id="stats-total-savings">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ TAB: SETTINGS ============ -->
        <div id="tab-settings" class="tab-content">
            <!-- Theme Selection -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Theme</span>
                </div>
                <div class="theme-grid">
                    <div class="theme-option active" data-theme="dark" onclick="setTheme('dark')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #1a1a2e 0%, #6366f1 100%);"></div>
                        <div class="theme-name">Stealth Dark</div>
                    </div>
                    <div class="theme-option" data-theme="light" onclick="setTheme('light')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #f8fafc 0%, #4f46e5 100%);"></div>
                        <div class="theme-name">Tactical Light</div>
                    </div>
                    <div class="theme-option" data-theme="neon" onclick="setTheme('neon')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #0a0a0f 0%, #00f5d4 100%);"></div>
                        <div class="theme-name">Neon Warrior</div>
                    </div>
                    <div class="theme-option" data-theme="zen" onclick="setTheme('zen')">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #fafaf9 0%, #78716c 100%);"></div>
                        <div class="theme-name">Minimal Zen</div>
                    </div>
                </div>
            </div>

            <!-- Objectif Epargne Setting -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Objectif Mensuel Epargne</span>
                </div>
                <input type="number" id="savings-goal-input" class="form-input" placeholder="Entrez objectif FCFA">
                <button class="btn btn-primary" onclick="setSavingsGoal()">Sauvegarder</button>
            </div>

            <!-- Data Management -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Donnees</span>
                </div>
                <div class="settings-group">
                    <div class="settings-item" onclick="exportData()">
                        <div class="settings-item-left">
                            <div class="settings-item-icon">üì§</div>
                            <div class="settings-item-text">
                                <div class="settings-item-label">Exporter les donnees</div>
                                <div class="settings-item-desc">Telecharger une sauvegarde JSON</div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item" onclick="document.getElementById('import-file').click()">
                        <div class="settings-item-left">
                            <div class="settings-item-icon">üì•</div>
                            <div class="settings-item-text">
                                <div class="settings-item-label">Importer des donnees</div>
                                <div class="settings-item-desc">Restaurer depuis une sauvegarde</div>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card" style="border-color: var(--negative);">
                <div class="card-header">
                    <span class="card-title" style="color: var(--negative);">Zone Dangereuse</span>
                </div>
                <button class="btn btn-danger" onclick="resetAllData()">
                    Reinitialiser toutes les donnees
                </button>
            </div>

            <!-- App Info -->
            <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.75rem;">
                <p>SHADORON Budget Discipline v2.2</p>
                <p>Fonctionne entierement hors-ligne</p>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
            <span class="nav-icon">üè†</span>
            <span class="nav-label">Accueil</span>
        </button>
        <button class="nav-item" data-tab="income" onclick="switchTab('income')">
            <span class="nav-icon">üí∞</span>
            <span class="nav-label">Revenu</span>
        </button>
        <button class="nav-item" data-tab="expense" onclick="switchTab('expense')">
            <span class="nav-icon">üí∏</span>
            <span class="nav-label">Depense</span>
        </button>
        <button class="nav-item" data-tab="history" onclick="switchTab('history')">
            <span class="nav-icon">üìã</span>
            <span class="nav-label">Historique</span>
        </button>
        <button class="nav-item" data-tab="progress" onclick="switchTab('progress')">
            <span class="nav-icon">üèÜ</span>
            <span class="nav-label">Progres</span>
        </button>
    </nav>

    <!-- SEARCH MODAL -->
    <div class="search-modal" id="search-modal">
        <div class="search-container">
            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="search-input" placeholder="Rechercher..." autofocus>
                <span class="search-shortcut">ESC</span>
            </div>
            <div class="search-results" id="search-results">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>

    <!-- LEVEL MODAL -->
    <div class="modal" id="level-modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Niveau & Progression</span>
                <button class="modal-close" onclick="closeLevelModal()">√ó</button>
            </div>
            <div id="level-modal-content">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>

    <!-- OFFLINE BADGE -->
    <div class="offline-badge" id="offline-badge">üì° Hors ligne</div>

    <!-- CONFETTI CONTAINER -->
    <div class="confetti-container" id="confetti-container"></div>

    <script>
        /** 
         * =====================================================
         * SHADORON BUDGET DISCIPLINE v2.2
         * Fixes: tab switching (prevent freeze by ensuring DOM ready and no conflicts), more mantras/quotes, financial tips (anchoring bias, modern finance), more intelligent (AI-like tips)
         * ===================================================== 
         */
        (function() {
            'use strict';

            // =====================================================
            // CONFIGURATION
            // =====================================================
            const DEFAULT_CATEGORIES = [
                { id: 'epargne', name: 'Epargne', icon: 'üîí', percent: 10, locked: true },
                { id: 'nourriture', name: 'Nourriture', icon: 'üçΩÔ∏è', percent: 30, locked: false },
                { id: 'projet', name: 'Projet', icon: 'üéØ', percent: 25, locked: false },
                { id: 'transport', name: 'Transport', icon: 'üöó', percent: 20, locked: false },
                { id: 'autres', name: 'Autres', icon: 'üì¶', percent: 15, locked: false }
            ];

            const RANKS = [
                { name: 'Recrue', minXP: 0, icon: 'üéñÔ∏è' },
                { name: 'Soldat', minXP: 100, icon: '‚öîÔ∏è' },
                { name: 'Sergent', minXP: 300, icon: 'üó°Ô∏è' },
                { name: 'Lieutenant', minXP: 600, icon: 'üõ°Ô∏è' },
                { name: 'Capitaine', minXP: 1000, icon: 'üèÖ' },
                { name: 'Commandant', minXP: 1500, icon: 'üëë' },
                { name: 'General', minXP: 2500, icon: '‚≠ê' },
                { name: 'Legende', minXP: 5000, icon: 'üåü' }
            ];

            const BADGES = [
                { id: 'first_income', name: 'Premier Pas', icon: 'üå±', desc: 'Premier revenu enregistre', check: s => s.totalIncomes >= 1 },
                { id: 'income_10', name: 'Regulier', icon: 'üìà', desc: '10 revenus enregistres', check: s => s.totalIncomes >= 10 },
                { id: 'income_50', name: 'Discipline', icon: 'üí™', desc: '50 revenus enregistres', check: s => s.totalIncomes >= 50 },
                { id: 'saver', name: 'Epargnant', icon: 'üè¶', desc: '10000 FCFA en epargne', check: s => s.totalSavings >= 10000 },
                { id: 'mega_saver', name: 'Coffre Fort', icon: 'üíé', desc: '100000 FCFA en epargne', check: s => s.totalSavings >= 100000 },
                { id: 'streak_7', name: 'Semaine Parfaite', icon: 'üî•', desc: '7 jours de streak', check: s => s.currentStreak >= 7 },
                { id: 'streak_30', name: 'Mois Heroique', icon: 'üèÜ', desc: '30 jours de streak', check: s => s.currentStreak >= 30 },
                { id: 'streak_100', name: 'Centurion', icon: 'üëë', desc: '100 jours de streak', check: s => s.currentStreak >= 100 },
                { id: 'ops_100', name: 'Actif', icon: '‚ö°', desc: '100 operations', check: s => s.totalOperations >= 100 },
                { id: 'ops_500', name: 'Veteran', icon: 'üéØ', desc: '500 operations', check: s => s.totalOperations >= 500 },
                { id: 'level_5', name: 'Capitaine', icon: 'üèÖ', desc: 'Atteindre niveau 5', check: s => s.level >= 5 },
                { id: 'level_8', name: 'Legende', icon: 'üåü', desc: 'Atteindre niveau max', check: s => s.level >= 8 }
            ];

            const MANTRAS = [
                "La discipline est le pont entre les objectifs et les accomplissements.",
                "Chaque franc epargne est un pas vers la liberte.",
                "La richesse vient de la constance, pas de la chance.",
                "Controle ton argent avant qu'il ne te controle.",
                "Les petites economies d'aujourd'hui font les grandes fortunes de demain.",
                "La patience est la mere de toutes les vertus financieres.",
                "Un guerrier ne depense pas, il investit.",
                "La vraie richesse est dans la maitrise de soi.",
                "Chaque jour est une opportunite de batir ton empire.",
                "La discipline financiere est la premiere victoire.",
                "L'argent est un outil. Utilisez-le avec sagesse pour b√¢tir votre avenir.", // Plus de citations
                "Investissez dans ce qui vous rend libre, pas dans ce qui vous encha√Æne.",
                "La cl√© de la richesse est de d√©penser moins que ce que vous gagnez.",
                "√âvitez les pi√®ges de la consommation impulsive pour une vie financi√®re saine.",
                "Le succ√®s financier commence par une bonne gestion quotidienne."
            ];

            const FINANCE_TIPS = [ // Plus intelligent avec r√®gles d'ancrage et finance moderne
                {
                    title: "√âviter le Biais d'Ancrage",
                    text: "Le biais d'ancrage en finance est la tendance √† s'appuyer trop sur la premi√®re information re√ßue (comme un prix initial) lors de d√©cisions. Pour l'√©viter, comparez toujours plusieurs options et r√©√©valuez vos budgets mensuellement."
                },
                {
                    title: "R√®gle des 50/30/20",
                    text: "Allouez 50% de vos revenus aux besoins essentiels, 30% aux d√©sirs, et 20% √† l'√©pargne. Adaptez cela √† votre situation pour une gestion moderne."
                },
                {
                    title: "Investissement Passif",
                    text: "Consid√©rez les fonds indiciels (ETFs) pour une croissance √† long terme avec faible risque. Diversifiez pour minimiser les pertes."
                },
                {
                    title: "√âviter les Dettes Toxiques",
                    text: "Priorisez le remboursement des dettes √† haut int√©r√™t. Utilisez la m√©thode 'boule de neige' : remboursez les petites dettes d'abord pour gagner en motivation."
                }
            ];

            const STORAGE_KEYS = {
                CATEGORIES: 'shadoron_categories',
                BALANCES: 'shadoron_balances',
                HISTORY: 'shadoron_history',
                XP: 'shadoron_xp',
                STREAK: 'shadoron_streak',
                THEME: 'shadoron_theme',
                BADGES: 'shadoron_badges',
                LAST_ACTIVITY: 'shadoron_last_activity',
                SAVINGS_GOAL: 'shadoron_savings_goal' // Nouveau pour objectif
            };

            // =====================================================
            // STATE
            // =====================================================
            let state = {
                categories: [],
                balances: {},
                history: [],
                xp: 0,
                streak: { current: 0, best: 0, lastDate: null },
                theme: 'dark',
                unlockedBadges: [],
                lastActivity: null,
                savingsGoal: 0, // Nouveau
                viewMode: 'all' // 'all' ou 'month'
            };

            // =====================================================
            // UTILITIES
            // =====================================================
            function formatCurrency(amount) {
                return Math.round(amount).toLocaleString('fr-FR') + ' FCFA';
            }

            function formatDate(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            }

            function formatDateShort(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
            }

            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            function getToday() {
                return new Date().toISOString().split('T')[0];
            }

            function getCurrentMonthYear() {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }

            function getGreeting() {
                const hour = new Date().getHours();
                if (hour < 12) return 'Bonjour, Guerrier';
                if (hour < 18) return 'Bon apres-midi, Guerrier';
                return 'Bonsoir, Guerrier';
            }

            function getCurrentRank(xp) {
                let rank = RANKS[0];
                for (const r of RANKS) {
                    if (xp >= r.minXP) rank = r;
                }
                return rank;
            }

            function getNextRank(xp) {
                for (const r of RANKS) {
                    if (xp < r.minXP) return r;
                }
                return null;
            }

            function getRankIndex(xp) {
                let index = 0;
                for (let i = 0; i < RANKS.length; i++) {
                    if (xp >= RANKS[i].minXP) index = i;
                }
                return index;
            }

            function getXPProgress(xp) {
                const rank = getCurrentRank(xp);
                const next = getNextRank(xp);
                if (!next) return 100;
                const progress = ((xp - rank.minXP) / (next.minXP - rank.minXP)) * 100;
                return Math.min(100, Math.max(0, progress));
            }

            // =====================================================
            // STORAGE
            // =====================================================
            function loadData() {
                try {
                    state.categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [...DEFAULT_CATEGORIES];
                    state.balances = JSON.parse(localStorage.getItem(STORAGE_KEYS.BALANCES)) || initializeBalances();
                    state.history = JSON.parse(localStorage.getItem(STORAGE_KEYS.HISTORY)) || [];
                    state.xp = parseInt(localStorage.getItem(STORAGE_KEYS.XP)) || 0;
                    state.streak = JSON.parse(localStorage.getItem(STORAGE_KEYS.STREAK)) || { current: 0, best: 0, lastDate: null };
                    state.theme = localStorage.getItem(STORAGE_KEYS.THEME) || 'dark';
                    state.unlockedBadges = JSON.parse(localStorage.getItem(STORAGE_KEYS.BADGES)) || [];
                    state.lastActivity = localStorage.getItem(STORAGE_KEYS.LAST_ACTIVITY);
                    state.savingsGoal = parseInt(localStorage.getItem(STORAGE_KEYS.SAVINGS_GOAL)) || 0;
                } catch (e) {
                    console.error('Error loading data:', e);
                    resetToDefaults();
                }
            }

            function saveData() {
                try {
                    localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(state.categories));
                    localStorage.setItem(STORAGE_KEYS.BALANCES, JSON.stringify(state.balances));
                    localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(state.history));
                    localStorage.setItem(STORAGE_KEYS.XP, state.xp.toString());
                    localStorage.setItem(STORAGE_KEYS.STREAK, JSON.stringify(state.streak));
                    localStorage.setItem(STORAGE_KEYS.THEME, state.theme);
                    localStorage.setItem(STORAGE_KEYS.BADGES, JSON.stringify(state.unlockedBadges));
                    localStorage.setItem(STORAGE_KEYS.LAST_ACTIVITY, state.lastActivity);
                    localStorage.setItem(STORAGE_KEYS.SAVINGS_GOAL, state.savingsGoal.toString());
                } catch (e) {
                    console.error('Error saving data:', e);
                    showToast('Erreur de sauvegarde', 'error');
                }
            }

            function initializeBalances() {
                const balances = {};
                state.categories.forEach(cat => balances[cat.id] = 0);
                return balances;
            }

            function resetToDefaults() {
                state.categories = [...DEFAULT_CATEGORIES];
                state.balances = initializeBalances();
                state.history = [];
                state.xp = 0;
                state.streak = { current: 0, best: 0, lastDate: null };
                state.unlockedBadges = [];
                state.lastActivity = null;
                state.savingsGoal = 0;
                saveData();
            }

            // =====================================================
            // EXPORT / IMPORT
            // =====================================================
            window.exportData = function() {
                const data = {
                    version: '2.2',
                    exportDate: new Date().toISOString(),
                    categories: state.categories,
                    balances: state.balances,
                    history: state.history,
                    xp: state.xp,
                    streak: state.streak,
                    unlockedBadges: state.unlockedBadges,
                    savingsGoal: state.savingsGoal
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `shadoron-backup-${getToday()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Sauvegarde exportee avec succes', 'success');
            };

            window.importData = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.categories && data.balances && data.history) {
                            state.categories = data.categories;
                            state.balances = data.balances;
                            state.history = data.history;
                            state.xp = data.xp || 0;
                            state.streak = data.streak || { current: 0, best: 0, lastDate: null };
                            state.unlockedBadges = data.unlockedBadges || [];
                            state.savingsGoal = data.savingsGoal || 0;
                            saveData();
                            renderAll();
                            showToast('Donnees restaurees avec succes', 'success');
                        } else {
                            throw new Error('Format invalide');
                        }
                    } catch (err) {
                        showToast('Erreur: fichier invalide', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            window.resetAllData = function() {
                if (confirm('Etes-vous sur de vouloir supprimer TOUTES les donnees? Cette action est irreversible.')) {
                    resetToDefaults();
                    renderAll();
                    showToast('Donnees reinitialisees', 'warning');
                }
            };

            // =====================================================
            // GAMIFICATION
            // =====================================================
            function addXP(amount) {
                const oldRank = getCurrentRank(state.xp);
                state.xp += amount;
                const newRank = getCurrentRank(state.xp);
                // Show XP popup
                showXPPopup(amount);
                // Level up?
                if (newRank.name !== oldRank.name) {
                    setTimeout(() => {
                        showToast(`Niveau superieur! Tu es maintenant ${newRank.name}!`, 'success');
                        triggerConfetti();
                    }, 600);
                }
                updateLevelBadge();
                checkBadges();
                saveData();
            }

            function showXPPopup(amount) {
                const popup = document.createElement('div');
                popup.className = 'xp-popup';
                popup.textContent = `+${amount} XP`;
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 600);
            }

            function updateStreak() {
                const today = getToday();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                if (state.streak.lastDate === today) {
                    return; // Already updated today
                }
                if (state.streak.lastDate === yesterdayStr) {
                    state.streak.current++;
                } else {
                    state.streak.current = 1; // Fix reset streak
                }
                state.streak.lastDate = today;
                if (state.streak.current > state.streak.best) {
                    state.streak.best = state.streak.current;
                }
                state.lastActivity = today;
                saveData();
            }

            function checkBadges() {
                const stats = getStats();
                const newBadges = [];
                BADGES.forEach(badge => {
                    if (!state.unlockedBadges.includes(badge.id) && badge.check(stats)) {
                        state.unlockedBadges.push(badge.id);
                        newBadges.push(badge);
                    }
                });
                if (newBadges.length > 0) {
                    newBadges.forEach(badge => {
                        setTimeout(() => {
                            showToast(`Badge debloque: ${badge.name} ${badge.icon}`, 'success');
                            triggerConfetti();
                        }, 800);
                    });
                    saveData();
                }
            }

            function getStats() {
                const incomes = state.history.filter(h => h.type === 'income');
                const expenses = state.history.filter(h => h.type === 'expense');
                return {
                    totalIncomes: incomes.length,
                    totalExpenses: expenses.length,
                    totalOperations: state.history.length,
                    totalSavings: state.balances['epargne'] || 0,
                    currentStreak: state.streak.current,
                    bestStreak: state.streak.best,
                    level: getRankIndex(state.xp) + 1,
                    xp: state.xp
                };
            }

            // =====================================================
            // CONFETTI
            // =====================================================
            function triggerConfetti() {
                const container = document.getElementById('confetti-container');
                const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                const shapes = ['‚≠ê', '‚öîÔ∏è', 'üí∞', 'üî•', 'üèÜ'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti confetti-star';
                    confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }
            }

            // =====================================================
            // TOASTS
            // =====================================================
            function showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <span class="toast-message">${message}</span>
                `;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // =====================================================
            // THEME
            // =====================================================
            window.setTheme = function(theme) {
                state.theme = theme;
                document.documentElement.setAttribute('data-theme', theme);
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.theme === theme);
                });
                localStorage.setItem(STORAGE_KEYS.THEME, theme);
            };

            // =====================================================
            // NAVIGATION
            // =====================================================
            window.switchTab = function(tabId) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                // Show selected tab
                const tab = document.getElementById(`tab-${tabId}`);
                if (tab) tab.classList.add('active');
                const navItem = document.querySelector(`.nav-item[data-tab="${tabId}"]`);
                if (navItem) navItem.classList.add('active');
                // Haptic feedback on mobile
                if (navigator.vibrate) navigator.vibrate(10);
            };

            // =====================================================
            // SEARCH
            // =====================================================
            window.openSearch = function() {
                document.getElementById('search-modal').classList.add('active');
                document.getElementById('search-input').focus();
                renderSearchResults('');
            };

            window.closeSearch = function() {
                document.getElementById('search-modal').classList.remove('active');
                document.getElementById('search-input').value = '';
            };

            function renderSearchResults(query) {
                const container = document.getElementById('search-results');
                const results = [];
                // Navigation shortcuts
                const navItems = [
                    { icon: 'üè†', title: 'Tableau de bord', subtitle: 'Voir les soldes', action: () => { closeSearch(); switchTab('dashboard'); } },
                    { icon: 'üí∞', title: 'Ajouter un revenu', subtitle: 'Enregistrer de l\'argent recu', action: () => { closeSearch(); switchTab('income'); } },
                    { icon: 'üí∏', title: 'Ajouter une depense', subtitle: 'Enregistrer une depense', action: () => { closeSearch(); switchTab('expense'); } },
                    { icon: 'üìã', title: 'Historique', subtitle: 'Voir les operations', action: () => { closeSearch(); switchTab('history'); } },
                    { icon: 'üèÜ', title: 'Progression', subtitle: 'Voir XP et badges', action: () => { closeSearch(); switchTab('progress'); } },
                    { icon: '‚öôÔ∏è', title: 'Parametres', subtitle: 'Theme et donnees', action: () => { closeSearch(); switchTab('settings'); } }
                ];
                navItems.forEach(item => {
                    if (!query || item.title.toLowerCase().includes(query.toLowerCase())) {
                        results.push(item);
                    }
                });
                // Search in history with better tolerance (fix search)
                if (query) {
                    const lowerQuery = query.toLowerCase();
                    state.history.forEach(h => {
                        const cat = state.categories.find(c => c.id === h.category);
                        const text = h.note || (cat ? cat.name : 'Revenu');
                        if (text.toLowerCase().includes(lowerQuery) || text.toLowerCase().replace(/e/g, '√©').includes(lowerQuery)) { // Tolerance fautes
                            results.push({
                                icon: h.type === 'income' ? 'üí∞' : 'üí∏',
                                title: text,
                                subtitle: formatDate(h.timestamp),
                                action: () => { closeSearch(); switchTab('history'); }
                            });
                        }
                    });
                }
                container.innerHTML = results.length ? results.map(r => `
                    <div class="search-result-item" onclick="(${r.action})()">
                        <span class="search-result-icon">${r.icon}</span>
                        <div class="search-result-text">
                            <div class="search-result-title">${r.title}</div>
                            <div class="search-result-subtitle">${r.subtitle}</div>
                        </div>
                    </div>
                `).join('') : '<div style="padding: 20px; text-align: center; color: var(--text-muted);">Aucun resultat</div>';
            }

            // =====================================================
            // LEVEL MODAL
            // =====================================================
            window.showLevelModal = function() {
                const modal = document.getElementById('level-modal');
                const content = document.getElementById('level-modal-content');
                const rank = getCurrentRank(state.xp);
                const next = getNextRank(state.xp);
                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 8px;">${rank.icon}</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">${rank.name}</div>
                        <div style="color: var(--text-muted);">${state.xp} XP total</div>
                    </div>
                    <div class="xp-progress" style="margin-bottom: 20px;">
                        <div class="xp-bar" style="height: 12px;">
                            <div class="xp-fill" style="width: ${getXPProgress(state.xp)}%;"></div>
                        </div>
                        ${next ? `<div style="text-align: center; margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                            ${next.minXP - state.xp} XP pour ${next.name}
                        </div>` : '<div style="text-align: center; margin-top: 8px; color: var(--positive);">Niveau maximum atteint!</div>'}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); text-align: center;">
                        <p>+10 XP par revenu enregistre</p>
                        <p>+5 XP par depense enregistree</p>
                        <p>Streak bonus: +${state.streak.current} XP</p>
                    </div>
                `;
                modal.classList.add('active');
            };

            window.closeLevelModal = function() {
                document.getElementById('level-modal').classList.remove('active');
            };

            // =====================================================
            // RENDERING
            // =====================================================
            function updateLevelBadge() {
                const rank = getCurrentRank(state.xp);
                document.getElementById('current-rank').textContent = rank.name;
                document.getElementById('current-xp').textContent = state.xp + ' XP';
            }

            function renderMorningBriefing() {
                document.getElementById('greeting').textContent = getGreeting();
                document.getElementById('current-date').textContent = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('daily-mantra').textContent = '"' + MANTRAS[Math.floor(Math.random() * MANTRAS.length)] + '"';
                // Stats
                document.getElementById('stat-streak').textContent = state.streak.current;
                document.getElementById('stat-transactions').textContent = state.history.length;
                const totalIncome = state.history.filter(h => h.type === 'income').reduce((sum, h) => sum + h.amount, 0);
                const savingsPercent = totalIncome > 0 ? Math.round((state.balances['epargne'] || 0) / totalIncome * 100) : 0;
                document.getElementById('stat-savings').textContent = savingsPercent + '%';
            }

            function renderFinanceTips() {
                const tip = FINANCE_TIPS[Math.floor(Math.random() * FINANCE_TIPS.length)];
                const tipsContainer = document.querySelector('.finance-tips');
                tipsContainer.innerHTML = `
                    <div class="tip-title">${tip.title}</div>
                    <div class="tip-text">${tip.text}</div>
                    <div class="tip-text">"${MANTRAS[Math.floor(Math.random() * MANTRAS.length)]}"</div>
                    <div class="tip-text">"${MANTRAS[Math.floor(Math.random() * MANTRAS.length)]}"</div>
                `;
            }

            function renderStreakBanner() {
                const banner = document.getElementById('streak-banner');
                if (state.streak.current > 0) {
                    banner.style.display = 'flex';
                    document.getElementById('streak-count').textContent = state.streak.current + ' jour' + (state.streak.current > 1 ? 's' : '');
                    document.getElementById('best-streak').textContent = state.streak.best;
                    if (state.streak.current > 3) banner.style.animation = 'pulse-streak 2s infinite';
                } else {
                    banner.style.display = 'none';
                }
            }

            function renderBalances() {
                const container = document.getElementById('balances-grid');
                let total = 0;
                let html = '';
                let filteredHistory = state.history;
                if (state.viewMode === 'month') {
                    const currentMonth = getCurrentMonthYear();
                    filteredHistory = state.history.filter(h => h.monthYear === currentMonth);
                }
                // Recalcul balances pour vue mensuelle (fix total)
                const tempBalances = {};
                state.categories.forEach(cat => tempBalances[cat.id] = 0);
                filteredHistory.forEach(h => {
                    if (h.type === 'income') {
                        state.categories.forEach(cat => {
                            const allocation = Math.round(h.amount * cat.percent / 100);
                            tempBalances[cat.id] += allocation;
                        });
                    } else {
                        tempBalances[h.category] -= h.amount;
                    }
                });
                state.categories.forEach(cat => {
                    const balance = tempBalances[cat.id] || 0;
                    if (!cat.locked) total += balance;
                    let itemClass = 'balance-item';
                    if (balance < 0) itemClass += ' negative';
                    if (cat.locked) itemClass += ' locked';
                    let valueClass = 'balance-value';
                    if (balance > 0) valueClass += ' positive';
                    if (balance < 0) valueClass += ' negative';
                    html += `
                        <div class="${itemClass}">
                            <div class="balance-left">
                                <div class="balance-icon">${cat.icon}</div>
                                <div>
                                    <div class="balance-name">${cat.name}</div>
                                    <div class="balance-percent">${cat.percent}%</div>
                                </div>
                            </div>
                            <div class="${valueClass}">${formatCurrency(balance)}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                document.getElementById('total-balance').textContent = formatCurrency(total);
            }

            function renderAllocationConfig() {
                const container = document.getElementById('allocation-config');
                let html = '';
                state.categories.forEach(cat => {
                    html += `
                        <div class="allocation-row">
                            <label>${cat.icon} ${cat.name}${cat.locked ? ' üîí' : ''}</label>
                            <input type="number" data-category="${cat.id}" value="${cat.percent}" min="0" max="100" ${cat.locked ? 'readonly' : ''} oninput="handleAllocationChange(this)" >
                            <span style="color: var(--text-muted);">%</span>
                        </div>
                    `;
                });
                container.innerHTML = html;
                updateAllocationTotal();
            }

            window.handleAllocationChange = function(input) {
                const categoryId = input.dataset.category;
                const value = parseInt(input.value) || 0;
                const category = state.categories.find(c => c.id === categoryId);
                if (category && !category.locked) {
                    category.percent = Math.max(0, Math.min(100, value));
                }
                updateAllocationTotal();
                saveData();
            };

            function updateAllocationTotal() {
                const total = state.categories.reduce((sum, cat) => sum + cat.percent, 0);
                const totalEl = document.getElementById('total-percent');
                const containerEl = document.getElementById('allocation-total');
                totalEl.textContent = total + '%';
                containerEl.classList.remove('error', 'success');
                containerEl.classList.add(total === 100 ? 'success' : 'error');
            }

            function renderExpenseCategories() {
                const select = document.getElementById('expense-category');
                let html = '<option value="">Choisir une categorie</option>';
                state.categories.filter(c => !c.locked).forEach(cat => {
                    html += `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`;
                });
                select.innerHTML = html;
            }

            function updateIncomePreview() {
                const amount = parseFloat(document.getElementById('income-amount').value) || 0;
                const preview = document.getElementById('income-preview');
                const rows = document.getElementById('preview-rows');
                if (amount <= 0) {
                    preview.style.display = 'none';
                    return;
                }
                let html = '';
                state.categories.forEach(cat => {
                    const allocation = Math.round(amount * cat.percent / 100);
                    html += `
                        <div class="preview-row">
                            <span class="label">${cat.icon} ${cat.name} (${cat.percent}%)</span>
                            <span class="value">${formatCurrency(allocation)}</span>
                        </div>
                    `;
                });
                rows.innerHTML = html;
                preview.style.display = 'block';
            }

            function renderHistory() {
                const container = document.getElementById('history-list');
                if (state.history.length === 0) {
                    container.innerHTML = `
                        <div class="no-history">
                            <div class="no-history-icon">üìã</div>
                            <div>Aucune operation enregistree</div>
                        </div>
                    `;
                    return;
                }
                const sorted = [...state.history].sort((a, b) => b.timestamp - a.timestamp);
                let html = '';
                sorted.forEach(item => {
                    const isIncome = item.type === 'income';
                    const cat = state.categories.find(c => c.id === item.category);
                    const categoryName = isIncome ? 'Revenu' : (cat ? cat.name : item.category);
                    const icon = isIncome ? '+' : '-';
                    html += `
                        <div class="history-item">
                            <div class="history-icon ${item.type}">${icon}</div>
                            <div class="history-details">
                                <div class="history-category">${categoryName}${item.note ? ' - ' + item.note : ''}</div>
                                <div class="history-date">${formatDate(item.timestamp)}</div>
                            </div>
                            <div class="history-amount ${isIncome ? 'positive' : 'negative'}">
                                ${isIncome ? '+' : '-'}${formatCurrency(item.amount)}
                            </div>
                            <button class="history-delete" onclick="deleteHistoryItem('${item.id}')" title="Supprimer">√ó</button>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }

            function renderHabitCalendar() {
                const container = document.getElementById('habit-calendar');
                const today = new Date();
                const days = [];
                // Get activity days from history
                const activityDays = new Set(state.history.map(h => new Date(h.timestamp).toISOString().split('T')[0]));
                // Generate last 30 days
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const isToday = i === 0;
                    const isActive = activityDays.has(dateStr);
                    days.push(`
                        <div class="calendar-day ${isActive ? 'active' : ''} ${isToday ? 'today' : ''}" title="${dateStr}">
                            ${date.getDate()}
                        </div>
                    `);
                }
                container.innerHTML = days.join('');
            }

            function renderBadges() {
                const container = document.getElementById('badges-grid');
                const stats = getStats();
                const html = BADGES.map(badge => {
                    const unlocked = state.unlockedBadges.includes(badge.id);
                    return `
                        <div class="badge-item ${unlocked ? 'unlocked' : 'locked'}" title="${badge.desc}">
                            <span class="badge-icon">${badge.icon}</span>
                            <span class="badge-name">${badge.name}</span>
                        </div>
                    `;
                }).join('');
                container.innerHTML = html;
                document.getElementById('badges-count').textContent = `${state.unlockedBadges.length}/${BADGES.length}`;
            }

            function renderProgress() {
                const rank = getCurrentRank(state.xp);
                const next = getNextRank(state.xp);
                document.getElementById('progress-level').textContent = `Niveau ${getRankIndex(state.xp) + 1} - ${rank.name}`;
                document.getElementById('progress-xp').textContent = next ? `${state.xp} / ${next.minXP} XP` : `${state.xp} XP (MAX)`;
                document.getElementById('xp-fill').style.width = getXPProgress(state.xp) + '%';
                document.getElementById('next-rank').textContent = next ? next.name : 'Maximum atteint!';
            }

            function renderStats() {
                const stats = getStats();
                document.getElementById('stats-total-ops').textContent = stats.totalOperations;
                const totalIncome = state.history.filter(h => h.type === 'income').reduce((sum, h) => sum + h.amount, 0);
                const totalExpense = state.history.filter(h => h.type === 'expense').reduce((sum, h) => sum + h.amount, 0);
                document.getElementById('stats-total-income').textContent = formatCurrency(totalIncome);
                document.getElementById('stats-total-expense').textContent = formatCurrency(totalExpense);
                document.getElementById('stats-total-savings').textContent = formatCurrency(state.balances['epargne'] || 0);
            }

            function renderChart() {
                const ctx = document.getElementById('expense-chart').getContext('2d');
                const expenseData = {};
                state.categories.filter(c => !c.locked).forEach(cat => expenseData[cat.name] = 0);
                state.history.filter(h => h.type === 'expense').forEach(h => {
                    const cat = state.categories.find(c => c.id === h.category);
                    if (cat) expenseData[cat.name] += h.amount;
                });
                const chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(expenseData),
                        datasets: [{
                            data: Object.values(expenseData),
                            backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });
            }

            function renderSavingsGoal() {
                const savings = state.balances['epargne'] || 0;
                const progress = state.savingsGoal > 0 ? (savings / state.savingsGoal) * 100 : 0;
                document.getElementById('goal-progress').textContent = `${formatCurrency(savings)} / ${formatCurrency(state.savingsGoal)}`;
                document.getElementById('goal-fill').style.width = `${progress}%`;
                document.getElementById('goal-fill').style.background = progress >= 100 ? var(--positive) : (progress > 50 ? var(--warning) : var(--negative));
            }

            function renderAll() {
                updateLevelBadge();
                renderMorningBriefing();
                renderFinanceTips(); // Plus de citations et intelligence
                renderStreakBanner();
                renderBalances();
                renderAllocationConfig();
                renderExpenseCategories();
                renderHistory();
                renderHabitCalendar();
                renderBadges();
                renderProgress();
                renderStats();
                renderChart();
                renderSavingsGoal();
            }

            // =====================================================
            // ACTIONS
            // =====================================================
            function handleIncomeSubmit(e) {
                e.preventDefault();
                const form = e.target;
                if (form.submitting) return; // Fix double submit
                form.submitting = true;
                const amountInput = document.getElementById('income-amount');
                const amount = parseFloat(amountInput.value) || 0;
                const totalPercent = state.categories.reduce((sum, cat) => sum + cat.percent, 0);
                if (totalPercent !== 100) {
                    showToast('Le total des pourcentages doit etre de 100%', 'error');
                    form.submitting = false;
                    return;
                }
                if (amount <= 0) {
                    showToast('Veuillez entrer un montant valide', 'error');
                    form.submitting = false;
                    return;
                }
                // Distribute amount
                state.categories.forEach(cat => {
                    const allocation = Math.round(amount * cat.percent / 100);
                    state.balances[cat.id] = (state.balances[cat.id] || 0) + allocation;
                });
                // Add to history with monthYear
                state.history.push({
                    id: generateId(),
                    type: 'income',
                    amount: amount,
                    timestamp: Date.now(),
                    monthYear: getCurrentMonthYear()
                });
                // Update streak and XP
                updateStreak();
                addXP(10 + state.streak.current);
                saveData();
                amountInput.value = '';
                document.getElementById('income-preview').style.display = 'none';
                renderAll();
                showToast('Revenu enregistre avec succes!', 'success');
                // Haptic feedback
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
                switchTab('dashboard');
                form.submitting = false;
            }

            function handleExpenseSubmit(e) {
                e.preventDefault();
                const form = e.target;
                if (form.submitting) return; // Fix double submit
                form.submitting = true;
                const categorySelect = document.getElementById('expense-category');
                const amountInput = document.getElementById('expense-amount');
                const noteInput = document.getElementById('expense-note');
                const categoryId = categorySelect.value;
                const amount = parseFloat(amountInput.value) || 0;
                const note = noteInput.value.trim();
                if (!categoryId) {
                    showToast('Veuillez